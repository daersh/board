name: Gemini AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Gemini APIë¡œ ë¦¬ë·° ë°›ê³  ëŒ“ê¸€ ë‹¬ê¸°
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            // 1. PRì˜ ë³€ê²½ëœ ì½”ë“œ(diff) ê°€ì ¸ì˜¤ê¸°
            const { data: diff_text } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              headers: { accept: 'application/vnd.github.v3.diff' }
            });

            // 2. Gemini API í˜¸ì¶œí•˜ê¸°
            const apiKey = process.env.GEMINI_API_KEY;
            const prompt = `ë‹¹ì‹ ì€ ì‹œë‹ˆì–´ ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œìì…ë‹ˆë‹¤. ë‹¤ìŒì€ ê¹ƒí—ˆë¸Œ PRì˜ ì½”ë“œ ë³€ê²½ì‚¬í•­(diff)ì…ë‹ˆë‹¤. ì´ë¥¼ ë¶„ì„í•´ì„œ ë²„ê·¸, ë³´ì•ˆ ì·¨ì•½ì , ê°€ë…ì„± ê°œì„  ë“±ì— ëŒ€í•œ ì½”ë“œ ë¦¬ë·°ë¥¼ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n${diff_text}`;
            
            const gemini_url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            
            const gemini_response = await fetch(gemini_url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
              })
            });
            
            const result = await gemini_response.json();
            
            if (!result.candidates) {
              console.log(result);
              throw new Error("Gemini API ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. API í‚¤ë‚˜ í• ë‹¹ëŸ‰ì„ í™•ì¸í•˜ì„¸ìš”.");
            }

            const review_comment = result.candidates[0].content.parts[0].text;

            // 3. PRì— ë¦¬ë·° ëŒ“ê¸€ ë‹¬ê¸°
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "ğŸ¤– **Gemini AI ë¦¬ë·° ê²°ê³¼:**\n\n" + review_comment
            });
