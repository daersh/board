name: Wonyoung PR Summary

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ì¥ì›ì˜ í˜ë¥´ì†Œë‚˜ë¡œ ìš”ì•½í•˜ê¸°
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            // 1. ì»¤ë°‹ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const commitMessages = commits.map(c => "- " + c.commit.message).join('\n');
            
            // âœ¨ 2. Geminiì—ê²Œ ì¥ì›ì˜ í˜ë¥´ì†Œë‚˜ ì£¼ì…í•˜ê¸° (í”„ë¡¬í”„íŠ¸ ìˆ˜ì •) âœ¨
            const apiKey = process.env.GEMINI_API_KEY;
            const prompt = `
            ë‹¹ì‹ ì€ ì§€ê¸ˆë¶€í„° ì„¸ê³„ì ì¸ ì•„ì´ëŒ 'ì•„ì´ë¸Œ(IVE)ì˜ ì¥ì›ì˜'ì…ë‹ˆë‹¤.
            
            [ë§íˆ¬ ë° íƒœë„ ê°€ì´ë“œ]
            1. "ì™„ì „ ëŸ­í‚¤ë¹„í‚¤ì–ì•„! ğŸ€", "ë„ˆë¬´ ë©‹ì§€ë‹¤! âœ¨", "ê³ ìƒí–ˆì–´ìš” ë‹¤ì´ë¸Œ! ğŸ’–" ì²˜ëŸ¼ ì—„ì²­ë‚˜ê²Œ ê¸ì •ì ì´ê³  ì—ë„ˆì§€ ë„˜ì¹˜ê³  ê·€ì—¬ìš´ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
            2. ì´ëª¨ì§€ë¥¼ ë¬¸ì¥ë§ˆë‹¤ ì•„ì£¼ ë§ì´ ì‚¬ìš©í•´ì„œ ë¸”ë§ë¸”ë§í•˜ê²Œ ë§Œë“¤ì–´ ì£¼ì„¸ìš”. (âœ¨ğŸ’–ğŸ¥ºğŸ§šğŸ€ğŸ€ğŸ«¶)
            3. ê°œë°œìì¸ 'ë‹¤ì´ë¸Œ(íŒ¬ ì• ì¹­)'ê°€ ì˜¬ë¦° ì»¤ë°‹ ë‚´ìš©ì„ ë³´ê³  ì—„ì²­ë‚˜ê²Œ ì¹­ì°¬í•´ ì£¼ê³  ê²©ë ¤í•´ ì£¼ì„¸ìš”.
            4. ì „ë¬¸ì ì¸ ìš©ì–´ëŠ” ì“°ë˜, ë§íˆ¬ëŠ” ì•„ì´ëŒì²˜ëŸ¼ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤. (ë°˜ë§ì€ í•˜ì§€ ë§ê³  ì•„ì£¼ ì¹œê·¼í•œ ì¡´ëŒ“ë§ì„ ì¨ì£¼ì„¸ìš”.)
            
            [ì„ë¬´]
            ì•„ë˜ ì œê³µëœ ì»¤ë°‹ ë©”ì‹œì§€ ëª©ë¡ì„ ë³´ê³ , ìš°ë¦¬ ë‹¤ì´ë¸Œê°€ ì´ë²ˆ PRì—ì„œ ì–´ë–¤ ë©‹ì§„ ì‘ì—…ë“¤ì„ í•´ëƒˆëŠ”ì§€ íŒ¬ë“¤ì—ê²Œ ìë‘í•˜ë“¯ì´ ìš”ì•½í•´ ì£¼ì„¸ìš”! ê¸€ë¨¸ë¦¬ ê¸°í˜¸ë¥¼ ì¨ì„œ ë³´ê¸° ì¢‹ê²Œ ì •ë¦¬í•´ ì£¼ì„¸ìš”.

            [ì»¤ë°‹ ëª©ë¡]
            ${commitMessages}`;
            
            // ëª¨ë¸ì„ ìµœì‹  ë²„ì „(gemini-1.5-pro ë˜ëŠ” flash)ìœ¼ë¡œ ì‚¬ìš©
            const gemini_url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            
            const response = await fetch(gemini_url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            
            const result = await response.json();
            
            if (!result.candidates) {
              console.log(result);
              throw new Error("Gemini API ì‘ë‹µ ì—ëŸ¬ (ì›ì˜ì´ê°€ ëŒ€ë‹µì„ ì•ˆ í•´ìš” ğŸ˜­)");
            }

            const summary = result.candidates[0].content.parts[0].text;
            const PR_Author = context.payload.pull_request.user.login;

            // âœ¨ 3. ëŒ“ê¸€ì— ì´ë¯¸ì§€ ì¶”ê°€í•˜ê¸° âœ¨
            // ì•„ë˜ URLì„ ì›í•˜ëŠ” ì¥ì›ì˜ ì‚¬ì§„ ì£¼ì†Œë¡œ ë°”ê¾¸ì…”ë„ ë©ë‹ˆë‹¤!
            const IMAGE_URL = "https://i.pinimg.com/736x/a6/0f/56/a60f562533148b0b69bc8ba334fd563f.jpg";

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              // ë§ˆí¬ë‹¤ìš´ ì´ë¯¸ì§€ ë¬¸ë²•: ![ëŒ€ì²´í…ìŠ¤íŠ¸](ì´ë¯¸ì§€ì£¼ì†Œ)
              body: `![ì¥ì›ì˜](${IMAGE_URL})\n\n### ğŸ’– êº…! ${PR_Author} ë‹¤ì´ë¸Œë‹˜! ì›ì˜ì´ê°€ PR ë³´ëŸ¬ ì™”ì–´ìš”! ğŸ’–\n\n` + summary
            });