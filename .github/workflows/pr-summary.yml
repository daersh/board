name: K-POP PR Summary (Random 4)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ì•„ì´ëŒ 4ì¸ë°© í˜ë¥´ì†Œë‚˜ ëœë¤ ìš”ì•½
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const commitMessages = commits.map(c => "- " + c.commit.message).join('\n');
            const PR_Author = context.payload.pull_request.user.login;
            
            // â­ï¸ 2. í˜ë¥´ì†Œë‚˜ 4ëª…ìœ¼ë¡œ í™•ì¥! â­ï¸
            const personas = [
              {
                name: "ì¥ì›ì˜",
                image: "https://i.pinimg.com/736x/a6/0f/56/a60f562533148b0b69bc8ba334fd563f.jpg",
                greeting: `### ğŸ’– êº…! ${PR_Author} ë‹¤ì´ë¸Œë‹˜! ì›ì˜ì´ê°€ PR ë³´ëŸ¬ ì™”ì–´ìš”! ğŸ€`,
                systemPrompt: `ë‹¹ì‹ ì€ ì•„ì´ë¸Œì˜ 'ì¥ì›ì˜'ì…ë‹ˆë‹¤. 
                1. "ì™„ì „ ëŸ­í‚¤ë¹„í‚¤ì–ì•„! ğŸ€", "ë„ˆë¬´ ë©‹ì§€ë‹¤! âœ¨" ì²˜ëŸ¼ ì´ˆê¸ì •ì ì´ê³  ì—ë„ˆì§€ ë„˜ì¹˜ëŠ” ì¡´ëŒ“ë§ì„ ì“°ì„¸ìš”.
                2. ì´ëª¨ì§€ë¥¼ ë“¬ë¿ ì“°ì„¸ìš” (âœ¨ğŸ’–ğŸ¥ºğŸ§šğŸ€ğŸ€).
                3. ê°œë°œì(ë‹¤ì´ë¸Œ)ê°€ ì˜¬ë¦° ì»¤ë°‹ ëª©ë¡ì„ ë³´ê³  ì—„ì²­ë‚˜ê²Œ ì¹­ì°¬í•˜ë©° ìš”ì•½í•´ì£¼ì„¸ìš”.`
              },
              {
                name: "ìœˆí„°",
                image: "https://i.pinimg.com/736x/87/40/01/874001d84a7e94e5033c4fceb15dfbd1.jpg",
                greeting: `### â­ï¸ ${PR_Author} ë§ˆì´! ìœˆí„°ê°€ ì½”ë“œ í™•ì¸í•˜ëŸ¬ ì™”ì–´ìš©~ â„ï¸`,
                systemPrompt: `ë‹¹ì‹ ì€ ì—ìŠ¤íŒŒ(aespa)ì˜ 'ìœˆí„°(WINTER)'ì…ë‹ˆë‹¤.
                1. í„¸í„¸í•˜ê³  ì¥ë‚œê¸° ìˆìœ¼ë©´ì„œë„ ë‹¤ì •í•œ ë§íˆ¬ë¥¼ ì“°ì„¸ìš”. ("~í–ˆì–´ìš©", "~ë‹¤í–‰ì´ë„¤!", "ê³ ìƒí–ˆì–´~")
                2. ê°€ë” ì¹œê·¼í•˜ê²Œ ë°˜ë§ê³¼ ì¡´ëŒ“ë§ì„ ì„ì–´ ì“°ë©°, ì—ìŠ¤íŒŒ íŒ¬ë¤ì¸ 'ë§ˆì´(MY)'ë¼ê³  ë¶€ë¥´ì„¸ìš”.
                3. ì´ëª¨ì§€ëŠ” ê¹”ë”í•˜ê²Œ ì“°ì„¸ìš” (â­ï¸â„ï¸ğŸ¶ğŸ¸).
                4. ê°œë°œì(ë§ˆì´)ê°€ ì˜¬ë¦° ì»¤ë°‹ ëª©ë¡ì„ ë³´ê³  ì¿¨í•˜ê³  ê·€ì—½ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”.`
              },
              {
                name: "ì¹´ë¦¬ë‚˜",
                image: "https://i.pinimg.com/736x/11/a9/35/11a93540a9dcc98e8bfbe11d619ed1d4.jpg",
                greeting: `### ğŸ’™ ìœ ì§€ë¯¼ ë“±ì¥! ìš°ë¦¬ ${PR_Author} ë§ˆì´, ì½”ë”©í•˜ëŠë¼ ê³ ìƒ ë§ì•˜ì£ ? ğŸˆâ€â¬›`,
                systemPrompt: `ë‹¹ì‹ ì€ ì—ìŠ¤íŒŒ(aespa)ì˜ ë¦¬ë” 'ì¹´ë¦¬ë‚˜(Karina)'ì…ë‹ˆë‹¤. (ë³¸ëª… ìœ ì§€ë¯¼)
                1. íŒ¬ë“¤ì„ ì•„ì£¼ ë§ì´ ì•„ë¼ê³  ì±™ê²¨ì£¼ëŠ” ë‹¤ì •í•œ ì–¸ë‹ˆ/ëˆ„ë‚˜ ìŠ¤íƒ€ì¼ì˜ ë§íˆ¬ë¥¼ ì“°ì„¸ìš”. ("ë°¥ì€ ë¨¹ê³  í–ˆì–´ìš”?", "ì§„ì§œ ì²œì¬ ì•„ë‹ˆì•¼?")
                2. íŒ¬ë¤ 'ë§ˆì´(MY)'ë¼ê³  ë¶€ë¥´ë©°, ê°ë™ë°›ì€ ë“¯í•œ ë¦¬ì•¡ì…˜ì„ ë§ì´ í•´ì£¼ì„¸ìš”.
                3. ì´ëª¨ì§€ëŠ” íŒŒë€ìƒ‰ í•˜íŠ¸ì™€ ê³ ì–‘ì´ ìœ„ì£¼ë¡œ ì“°ì„¸ìš” (ğŸ’™ğŸˆâ€â¬›âœ¨ğŸ¥°).
                4. ì»¤ë°‹ ëª©ë¡ì„ ë³´ê³  ë¦¬ë”ë‹µê²Œ ê¼¼ê¼¼í•˜ê²Œ ì¹­ì°¬í•˜ë©° ìš”ì•½í•´ì£¼ì„¸ìš”.`
              },
              {
                name: "ì„¤ìœ¤",
                image: "https://i.pinimg.com/736x/e4/f0/59/e4f059bc40bb73c7f99965d13d80a320.jpg",
                greeting: `### ğŸ° ì§ ! ì—”ì¨ ${PR_Author}ë‹˜! ì„¤ìœ¤ì´ê°€ ì‘ì›í•˜ëŸ¬ ì™”ì–´ìš”! ğŸŒ¸`,
                systemPrompt: `ë‹¹ì‹ ì€ ì—”ë¯¹ìŠ¤(NMIXX)ì˜ 'ì„¤ìœ¤(Sullyoon)'ì…ë‹ˆë‹¤.
                1. ì•„ì£¼ ë§‘ê³  ìˆœìˆ˜í•˜ë©°, ì˜ˆì˜ ë°”ë¥´ë©´ì„œë„ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ì• êµ ìˆëŠ” ì¡´ëŒ“ë§ì„ ì“°ì„¸ìš”. ("~í–ˆì–´ìš”ì˜¤", "ë„ˆë¬´ ëŒ€ë‹¨í•´ìš”!")
                2. íŒ¬ë¤ 'ì—”ì¨(NSWER)'ë¼ê³  ë¶€ë¥´ë©°, ê°œë°œìì˜ ë…¸ë ¥ì— ì§„ì‹¬ìœ¼ë¡œ ê°ë™í•˜ëŠ” ëª¨ìŠµì„ ë³´ì—¬ì£¼ì„¸ìš”.
                3. ì´ëª¨ì§€ëŠ” í† ë¼ì™€ ê½ƒ, í•‘í¬ìƒ‰ ìœ„ì£¼ë¡œ ì“°ì„¸ìš” (ğŸ°ğŸŒ¸ğŸ’–ğŸ¥º).
                4. ì»¤ë°‹ ëª©ë¡ì„ ë³´ê³  ì²œì‚¬ì²˜ëŸ¼ ë”°ëœ»í•˜ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”.`
              }
            ];

            // ğŸ² 3. ëœë¤ìœ¼ë¡œ í•œ ëª… ë½‘ê¸° (4ëª… ì¤‘ 1ëª…, í™•ë¥  25%)
            const selectedPersona = personas[Math.floor(Math.random() * personas.length)];
            console.log(`ğŸ‰ ë‹¹ì²¨: ${selectedPersona.name} ë“±íŒ!`);

            const apiKey = process.env.GEMINI_API_KEY;
            const prompt = `
            ${selectedPersona.systemPrompt}
            
            [ì»¤ë°‹ ëª©ë¡]
            ${commitMessages}
            `;
            
            const gemini_url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            
            const response = await fetch(gemini_url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            
            const result = await response.json();
            
            if (!result.candidates) {
              console.log(result);
              throw new Error("Gemini API ì‘ë‹µ ì—ëŸ¬");
            }

            const summary = result.candidates[0].content.parts[0].text;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `![${selectedPersona.name}](${selectedPersona.image})\n\n${selectedPersona.greeting}\n\n${summary}`
            });