name: K-POP PR Summary (Random 4)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ì•„ì´ëŒ 4ì¸ë°© í˜ë¥´ì†Œë‚˜ ëœë¤ ìš”ì•½
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const commitMessages = commits.map(c => "- " + c.commit.message).join('\n');
            const PR_Author = context.payload.pull_request.user.login;
            
            // â­ï¸ 2. í˜ë¥´ì†Œë‚˜ë³„ ì´ë¯¸ì§€ë¥¼ ë°°ì—´(ë¦¬ìŠ¤íŠ¸)ë¡œ ë³€ê²½! â­ï¸
            const personas = [
              {
                name: "ì¥ì›ì˜",
                // ğŸ‘‡ ì´ë ‡ê²Œ ëŒ€ê´„í˜¸ [ ] ì•ˆì— ì£¼ì†Œë¥¼ ì—¬ëŸ¬ ê°œ ë„£ìŠµë‹ˆë‹¤. 
                // 10ê°œê°€ ì•„ë‹ˆì–´ë„ ê´œì°®ìŠµë‹ˆë‹¤. ìˆëŠ” ë§Œí¼ë§Œ ëœë¤ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤!
                images: [
                  "https://github.com/user-attachments/assets/ì›ì˜ì‚¬ì§„1",
                  "https://github.com/user-attachments/assets/ì›ì˜ì‚¬ì§„2",
                  "https://github.com/user-attachments/assets/ì›ì˜ì‚¬ì§„3"
                  // ... ì—¬ê¸°ì— ê³„ì† ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•´ì„œ ì¶”ê°€í•˜ì‹œë©´ ë©ë‹ˆë‹¤!
                ],
                greeting: `### ğŸ’– êº…! ${PR_Author} ë‹¤ì´ë¸Œë‹˜! ì›ì˜ì´ê°€ PR ë³´ëŸ¬ ì™”ì–´ìš”! ğŸ€`,
                systemPrompt: `ë‹¹ì‹ ì€ ì•„ì´ë¸Œì˜ 'ì¥ì›ì˜'ì…ë‹ˆë‹¤. 
                1. "ì™„ì „ ëŸ­í‚¤ë¹„í‚¤ì–ì•„! ğŸ€", "ë„ˆë¬´ ë©‹ì§€ë‹¤! âœ¨" ì²˜ëŸ¼ ì´ˆê¸ì •ì ì´ê³  ì—ë„ˆì§€ ë„˜ì¹˜ëŠ” ì¡´ëŒ“ë§ì„ ì“°ì„¸ìš”.
                2. ì´ëª¨ì§€ë¥¼ ë“¬ë¿ ì“°ì„¸ìš” (âœ¨ğŸ’–ğŸ¥ºğŸ§šğŸ€ğŸ€).
                3. ê°œë°œì(ë‹¤ì´ë¸Œ)ê°€ ì˜¬ë¦° ì»¤ë°‹ ëª©ë¡ì„ ë³´ê³  ì—„ì²­ë‚˜ê²Œ ì¹­ì°¬í•˜ë©° ìš”ì•½í•´ì£¼ì„¸ìš”.`
              },
              {
                name: "ìœˆí„°",
                images: [
                  "https://github.com/user-attachments/assets/ìœˆí„°ì‚¬ì§„1",
                  "https://github.com/user-attachments/assets/ìœˆí„°ì‚¬ì§„2"
                  // ... ìœˆí„° ì‚¬ì§„ë“¤
                ],
                greeting: `### â­ï¸ ${PR_Author} ë§ˆì´! ìœˆí„°ê°€ ì½”ë“œ í™•ì¸í•˜ëŸ¬ ì™”ì–´ìš©~ â„ï¸`,
                systemPrompt: `ë‹¹ì‹ ì€ ì—ìŠ¤íŒŒ(aespa)ì˜ 'ìœˆí„°(WINTER)'ì…ë‹ˆë‹¤.
                1. í„¸í„¸í•˜ê³  ì¥ë‚œê¸° ìˆìœ¼ë©´ì„œë„ ë‹¤ì •í•œ ë§íˆ¬ë¥¼ ì“°ì„¸ìš”.
                2. ì¹œê·¼í•˜ê²Œ ë°˜ë§ê³¼ ì¡´ëŒ“ë§ì„ ì„ì–´ ì“°ë©°, íŒ¬ë¤ 'ë§ˆì´(MY)'ë¼ê³  ë¶€ë¥´ì„¸ìš”.
                3. ì´ëª¨ì§€ëŠ” ê¹”ë”í•˜ê²Œ ì“°ì„¸ìš” (â­ï¸â„ï¸ğŸ¶ğŸ¸).
                4. ì»¤ë°‹ ëª©ë¡ì„ ë³´ê³  ì¿¨í•˜ê³  ê·€ì—½ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”.`
              },
              {
                name: "ì¹´ë¦¬ë‚˜",
                images: [
                  "https://github.com/user-attachments/assets/ì¹´ë¦¬ë‚˜ì‚¬ì§„1",
                  "https://github.com/user-attachments/assets/ì¹´ë¦¬ë‚˜ì‚¬ì§„2"
                  // ... ì¹´ë¦¬ë‚˜ ì‚¬ì§„ë“¤
                ],
                greeting: `### ğŸ’™ ìœ ì§€ë¯¼ ë“±ì¥! ìš°ë¦¬ ${PR_Author} ë§ˆì´, ì½”ë”©í•˜ëŠë¼ ê³ ìƒ ë§ì•˜ì£ ? ğŸˆâ€â¬›`,
                systemPrompt: `ë‹¹ì‹ ì€ ì—ìŠ¤íŒŒ(aespa)ì˜ ë¦¬ë” 'ì¹´ë¦¬ë‚˜(Karina)'ì…ë‹ˆë‹¤.
                1. íŒ¬ë“¤ì„ ì•„ì£¼ ë§ì´ ì•„ë¼ê³  ì±™ê²¨ì£¼ëŠ” ë‹¤ì •í•œ ì–¸ë‹ˆ/ëˆ„ë‚˜ ìŠ¤íƒ€ì¼ì˜ ë§íˆ¬ë¥¼ ì“°ì„¸ìš”.
                2. íŒ¬ë¤ 'ë§ˆì´(MY)'ë¼ê³  ë¶€ë¥´ë©°, ê°ë™ë°›ì€ ë¦¬ì•¡ì…˜ì„ ë§ì´ í•´ì£¼ì„¸ìš”.
                3. ì´ëª¨ì§€ëŠ” íŒŒë€ í•˜íŠ¸ì™€ ê³ ì–‘ì´ ìœ„ì£¼ë¡œ ì“°ì„¸ìš” (ğŸ’™ğŸˆâ€â¬›âœ¨ğŸ¥°).
                4. ê¼¼ê¼¼í•˜ê²Œ ì¹­ì°¬í•˜ë©° ìš”ì•½í•´ì£¼ì„¸ìš”.`
              },
              {
                name: "ì„¤ìœ¤",
                images: [
                  "https://github.com/user-attachments/assets/ì„¤ìœ¤ì‚¬ì§„1",
                  "https://github.com/user-attachments/assets/ì„¤ìœ¤ì‚¬ì§„2"
                  // ... ì„¤ìœ¤ ì‚¬ì§„ë“¤
                ],
                greeting: `### ğŸ° ì§ ! ì—”ì¨ ${PR_Author}ë‹˜! ì„¤ìœ¤ì´ê°€ ì‘ì›í•˜ëŸ¬ ì™”ì–´ìš”! ğŸŒ¸`,
                systemPrompt: `ë‹¹ì‹ ì€ ì—”ë¯¹ìŠ¤(NMIXX)ì˜ 'ì„¤ìœ¤(Sullyoon)'ì…ë‹ˆë‹¤.
                1. ë§‘ê³  ìˆœìˆ˜í•˜ë©°, ì˜ˆì˜ ë°”ë¥´ë©´ì„œë„ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ì• êµ ìˆëŠ” ì¡´ëŒ“ë§ì„ ì“°ì„¸ìš”.
                2. íŒ¬ë¤ 'ì—”ì¨(NSWER)'ë¼ê³  ë¶€ë¥´ë©° ì§„ì‹¬ìœ¼ë¡œ ê°ë™í•˜ëŠ” ëª¨ìŠµì„ ë³´ì—¬ì£¼ì„¸ìš”.
                3. ì´ëª¨ì§€ëŠ” í† ë¼ì™€ ê½ƒ ìœ„ì£¼ë¡œ ì“°ì„¸ìš” (ğŸ°ğŸŒ¸ğŸ’–ğŸ¥º).
                4. ì²œì‚¬ì²˜ëŸ¼ ë”°ëœ»í•˜ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”.`
              }
            ];

            // ğŸ² 3. ëœë¤ìœ¼ë¡œ ë©¤ë²„ 1ëª… ë½‘ê¸° (1ì°¨ ê°€ì± )
            const selectedPersona = personas[Math.floor(Math.random() * personas.length)];
            
            // ğŸ“¸ 4. ë½‘íŒ ë©¤ë²„ì˜ ì‚¬ì§„ ë¦¬ìŠ¤íŠ¸ ì¤‘ì—ì„œ 1ì¥ ëœë¤ ë½‘ê¸°! (2ì°¨ ê°€ì± )
            const randomImage = selectedPersona.images[Math.floor(Math.random() * selectedPersona.images.length)];
            
            console.log(`ğŸ‰ ë‹¹ì²¨: ${selectedPersona.name} ë“±íŒ!`);

            const apiKey = process.env.GEMINI_API_KEY;
            const prompt = `
            ${selectedPersona.systemPrompt}
            
            [ì»¤ë°‹ ëª©ë¡]
            ${commitMessages}
            `;
            
            const gemini_url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            
            const response = await fetch(gemini_url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            
            const result = await response.json();
            
            if (!result.candidates) {
              console.log(result);
              throw new Error("Gemini API ì‘ë‹µ ì—ëŸ¬");
            }

            const summary = result.candidates[0].content.parts[0].text;

            // âœ¨ 5. ëŒ“ê¸€ ë‹¬ê¸° (ëœë¤ìœ¼ë¡œ ë½‘íŒ ì´ë¯¸ì§€ ë³€ìˆ˜ì¸ randomImage ì‚¬ìš©!)
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              // width="250" ì„ ë„£ì–´ì„œ ì‚¬ì§„ì´ ë„ˆë¬´ ë¬´ì‹í•˜ê²Œ(?) í¬ì§€ ì•Šê³  ì˜ˆì˜ê²Œ ë‚˜ì˜¤ë„ë¡ ì¡°ì ˆí–ˆìŠµë‹ˆë‹¤.
              body: `<img src="${randomImage}" width="250">\n\n${selectedPersona.greeting}\n\n${summary}`
            });